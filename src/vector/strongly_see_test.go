package vector

import (
	"fmt"
	"math/rand"
	"strconv"
	"strings"
	"testing"

	"github.com/stretchr/testify/assert"

	"github.com/Fantom-foundation/go-lachesis/src/hash"
	"github.com/Fantom-foundation/go-lachesis/src/inter"
	"github.com/Fantom-foundation/go-lachesis/src/inter/idx"
	"github.com/Fantom-foundation/go-lachesis/src/inter/ordering"
	"github.com/Fantom-foundation/go-lachesis/src/inter/pos"
	"github.com/Fantom-foundation/go-lachesis/src/kvdb"
	"github.com/Fantom-foundation/go-lachesis/src/logger"
)

func TestStronglySeenClassic(t *testing.T) {

	t.Run("step 3", func(t *testing.T) {
		testStronglySeen(t, `
a0_1(3)  b0_1     c0_1
║        ║        ║
╠─────── b1_2     ║
║        ║        ║
║        ╠─────── c1_3
║        ║        ║
`)
	})

	t.Run("step 4", func(t *testing.T) {
		testStronglySeen(t, `
a0_1(3)  b0_1     c0_1
║        ║        ║
╠─────── b1_2     ║
║        ║        ║
║        ╠─────── c1_3
║        ║        ║
║        b2_4 ────╣
║        ║        ║
`)
	})

	t.Run("step 5", func(t *testing.T) {
		testStronglySeen(t, `
a0_1(3)  b0_1(5)  c0_1(5)
║        ║        ║
╠─────── b1_2(5)  ║
║        ║        ║
║        ╠─────── c1_3(5)
║        ║        ║
║        b2_4 ────╣
║        ║        ║
a1_5 ────╣        ║
║        ║        ║
`)
	})

}

// testStronglySeen uses event name agreement:
//  "<name>_<level>[(by-level)]",
// where by-level means that event is strongly seen by all event with level >= by-level.
func testStronglySeen(t *testing.T, dag string) {
	logger.SetTestMode(t)
	assertar := assert.New(t)

	peers, _, named := inter.ASCIIschemeToDAG(dag)

	members := make(pos.Members, len(peers))
	for _, peer := range peers {
		members.Add(peer, pos.Stake(1))
	}

	vi := NewIndex(members, kvdb.NewMemDatabase())

	processed := make(map[hash.Event]*inter.Event)
	orderThenProcess, _ := ordering.EventBuffer(ordering.Callback{

		Process: func(e *inter.Event) error {
			processed[e.Hash()] = e
			vi.Add(e)
			vi.Flush()
			return nil
		},

		Drop: func(e *inter.Event, peer string, err error) {
			t.Fatal(e, err)
		},

		Exists: func(h hash.Event) *inter.Event {
			return processed[h]
		},
	})

	// push
	for _, e := range named {
		orderThenProcess(e, "")
	}

	// check
	for dsc, ev := range named {
		_, bylevel := decode(dsc)
		for dsc, by := range named {
			level, _ := decode(dsc)

			who := by.Hash()
			whom := ev.Hash()
			if !assertar.Equal(
				bylevel > 0 && bylevel <= level,
				vi.StronglySee(who, whom),
				fmt.Sprintf("%s strongly sees %s", who.String(), whom.String()),
			) {
				return
			}
		}
	}
}

func decode(dsc string) (level, bylevel int64) {
	var err error

	s := strings.Split(dsc, "_")
	s = strings.Split(s[1], "(")

	level, err = strconv.ParseInt(s[0], 10, 32)
	if err != nil {
		panic(err)
	}

	if len(s) < 2 {
		return
	}

	bylevel, err = strconv.ParseInt(strings.TrimRight(s[1], ")"), 10, 32)
	if err != nil {
		panic(err)
	}

	return
}

func TestStronglySeenRandom(t *testing.T) {
	assertar := assert.New(t)

	// generated by codegen4StronglySeenStability()
	dag := `
 a000    
 ║        ║       
 ╠═══════ b000    
 ║        ║        ║       
 ║        ║        c000    
 ║        ║        ║        ║       
 ╠═══════─╫─══════─╫─══════ d000    
 ║        ║        ║        ║       
 a001════─╫─══════─╫─═══════╣       
 ║        ║        ║        ║       
 ╠═══════ b001     ║        ║       
 ║        ║        ║        ║       
 ║        ╠═══════ c001     ║       
 ║        ║        ║        ║       
 ║        b002═════╣        ║       
 ║        ║        ║        ║       
 ║        ║        ╠═══════ d001    
 ║        ║        ║        ║       
 a002════─╫─══════─╫─═══════╣       
 ║        ║        ║        ║       
 a003═════╣        ║        ║       
 ║        ║        ║        ║       
 ╠═══════ b003     ║        ║       
 ║        ║        ║        ║       
 ║        ║        c002═════╣       
 ║        ║║       ║        ║       
 ║        ║╚══════─╫─══════ d002    
 ║        ║        ║        ║       
 ║        ║        c003═════╣       
 ║        ║        ║        ║       
 ║        ║        ╠═══════ d003    
 ║        ║        ║        ║       
 a004════─╫─══════─╫─═══════╣       
 ║        ║        ║        ║       
 ╠═══════ b004     ║        ║       
 ║        ║        ║        ║       
 ║        ║        c004═════╣       
 ║        ║        ║        ║       
 a005════─╫─═══════╣        ║       
 ║        ║        ║        ║       
 ╠═══════ b005     ║        ║       
 ║        ║        ║        ║       
 ║        ╠═══════ c005     ║       
 ║        ║        ║        ║       
 a006════─╫─═══════╣        ║       
 ║        ║        ║║       ║       
 ║        ║        ║╚══════ d004    
 ║        ║        ║        ║       
 ║        ╠═══════─╫─══════ d005    
 ║        ║        ║        ║       
 ║        b006════─╫─═══════╣       
 ║        ║        ║        ║       
 a007═════╣        ║        ║       
 ║        ║        ║        ║       
 ║        ║        c006═════╣       
 ║        ║        ║        ║       
 ║        ╠═══════─╫─══════ d006    
 ║        ║        ║        ║       
 ║        b007════─╫─═══════╣       
 ║        ║        ║        ║       
 ║        ║        c007═════╣       
 ║        ║        ║        ║       
 ╠═══════─╫─══════─╫─══════ d007    
 ║        ║        ║        ║       
 a008════─╫─══════─╫─═══════╣       
 ║        ║        ║        ║       
 ║        b008════─╫─═══════╣       
 ║        ║        ║        ║       
 ║        ╠═══════ c008     ║       
 ║        ║        ║        ║       
 a009════─╫─═══════╣        ║       
 ║        ║        ║        ║       
 ╠═══════ b009     ║        ║       
 ║        ║        ║        ║       
 ║        ║        ╠═══════ d008    
 ║        ║        ║        ║       
 ║        ║        c009═════╣       
 ║        ║        ║        ║       
 ║        b010═════╣        ║       
 ║        ║        ║        ║       
 ║        ║        ╠═══════ d009    
 ║        ║        ║        ║       
 a010════─╫─══════─╫─═══════╣       
 ║        ║        ║        ║       
 ╠═══════─╫─══════ c010     ║       
 ║        ║        ║        ║       
 ║        b011═════╣        ║       
 ║        ║        ║        ║       
 ║        ╠═══════ c011     ║       
 ║        ║║       ║        ║       
 ║        ║╚══════─╫─══════ d010    
 ║        ║        ║        ║       
 a011════─╫─══════─╫─═══════╣       
 ║        ║        ║        ║       
 a012════─╫─═══════╣        ║       
 ║        ║        ║        ║       
 ╠═══════ b012     ║        ║       
 ║        ║        ║        ║       
 ╠═══════─╫─══════ c012     ║       
 ║        ║        ║        ║       
 ║        b013═════╣        ║       
 ║        ║        ║        ║       
 ║        ╠═══════ c013     ║       
 ║        ║3       ║        ║       
 ║        ║╚══════─╫─══════ d011    
 ║        ║        ║║       ║       
 ║        ║        ║╚══════ d012    
 ║        ║        ║        ║       
 a013════─╫─══════─╫─═══════╣       
 ║        ║        ║        ║       
 a014═════╣        ║        ║       
 ║        ║        ║        ║       
 ╠═══════─╫─══════ c014     ║       
 ║        ║        ║║       ║       
 ║        ║        ║╚══════ d013    
 ║        ║        ║        ║       
 ║        b014════─╫─═══════╣       
 ║        ║        ║        ║       
 a015═════╣        ║        ║       
 ║        ║        ║        ║       
 ║        b015═════╣        ║       
 ║        ║        ║        ║       
 ║        ╠═══════ c015     ║       
 ║        ║        ║        ║       
 a016════─╫─═══════╣        ║       
 ║        ║        ║        ║       
 ║        b016═════╣        ║       
 ║        ║        ║        ║       
 ╠═══════─╫─══════ c016     ║       
 ║        ║        ║        ║       
 a017════─╫─═══════╣        ║       
 ║        ║        ║        ║       
 ║        b017═════╣        ║       
 ║        ║        ║        ║       
 a018═════╣        ║        ║       
 ║5       ║        ║        ║       
 ║╚══════─╫─══════─╫─══════ d014    
 ║        ║        ║║       ║       
 ║        ║        ║╚══════ d015    
 ║3       ║        ║        ║       
 ║╚══════─╫─══════─╫─══════ d016    
 ║        ║        ║        ║       
 ║        ║        c017═════╣       
 ║        ║        ║        ║       
 ║        b018═════╣        ║       
 ║        ║        ║        ║       
 ║        ╠═══════ c018     ║       
 ║        ║║       ║        ║       
 ║        ║╚══════─╫─══════ d017    
 ║        ║        ║        ║       
 ║        ║        ╠═══════ d018    
 ║        ║        ║        ║       
 a019════─╫─══════─╫─═══════╣       
 ║        ║        ║        ║       
 ║        b019════─╫─═══════╣       
 ║        ║        ║        ║       
 ╠═══════─╫─══════ c019     ║       
 ║        ║        ║        ║       
 ║        ║        ╠═══════ d019    
`
	relations := map[string]map[string]struct{}{
		"a000": map[string]struct{}{},
		"a001": map[string]struct{}{},
		"a002": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "c000": {}, "c001": {}, "d000": {}},
		"a003": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "c000": {}, "c001": {}, "d000": {}},
		"a004": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "d000": {}, "d001": {}, "d002": {}},
		"a005": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"a006": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"a007": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}},
		"a008": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}},
		"a009": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}},
		"a010": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}},
		"a011": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}},
		"a012": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}},
		"a013": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"a014": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"a015": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"a016": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"a017": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"a018": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "c016": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"a019": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "b016": {}, "b017": {}, "b018": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "c016": {}, "c017": {}, "c018": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}, "d014": {}, "d015": {}, "d016": {}},
		"b000": map[string]struct{}{},
		"b001": map[string]struct{}{"a000": {}, "d000": {}},
		"b002": map[string]struct{}{"a000": {}, "a001": {}, "d000": {}},
		"b003": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "c000": {}, "c001": {}, "d000": {}, "d001": {}},
		"b004": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"b005": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"b006": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"b007": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"b008": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}},
		"b009": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}},
		"b010": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}},
		"b011": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}},
		"b012": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"b013": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"b014": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"b015": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}},
		"b016": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"b017": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"b018": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}, "d014": {}, "d015": {}, "d016": {}},
		"b019": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "b016": {}, "b017": {}, "b018": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "c016": {}, "c017": {}, "c018": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}, "d014": {}, "d015": {}, "d016": {}},
		"c000": map[string]struct{}{},
		"c001": map[string]struct{}{"a000": {}, "a001": {}, "d000": {}},
		"c002": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "d000": {}},
		"c003": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "d000": {}},
		"c004": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "d000": {}},
		"c005": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"c006": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"c007": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}},
		"c008": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}},
		"c009": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}},
		"c010": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}},
		"c011": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}},
		"c012": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"c013": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"c014": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}},
		"c015": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"c016": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"c017": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"c018": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}, "d014": {}, "d015": {}, "d016": {}},
		"c019": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "b016": {}, "b017": {}, "b018": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "c016": {}, "c017": {}, "c018": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}, "d014": {}, "d015": {}, "d016": {}, "d017": {}, "d018": {}},
		"d000": map[string]struct{}{},
		"d001": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "d000": {}},
		"d002": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "c000": {}, "c001": {}, "d000": {}},
		"d003": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "d000": {}},
		"d004": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "d000": {}},
		"d005": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"d006": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"d007": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}},
		"d008": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}},
		"d009": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}},
		"d010": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}},
		"d011": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}},
		"d012": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"d013": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"d014": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"d015": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"d016": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"d017": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "c016": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"d018": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "b016": {}, "b017": {}, "b018": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "c016": {}, "c017": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}, "d014": {}, "d015": {}, "d016": {}},
		"d019": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "a017": {}, "a018": {}, "a019": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "b016": {}, "b017": {}, "b018": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "c016": {}, "c017": {}, "c018": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}, "d014": {}, "d015": {}, "d016": {}, "d017": {}, "d018": {}},
	}

	peers, _, named := inter.ASCIIschemeToDAG(dag)
	members := make(pos.Members, len(peers))
	for _, peer := range peers {
		members.Add(peer, pos.Stake(1))
	}

	vi := NewIndex(members, kvdb.NewMemDatabase())

	processed := make(map[hash.Event]*inter.Event)
	orderThenProcess, _ := ordering.EventBuffer(ordering.Callback{

		Process: func(e *inter.Event) error {
			processed[e.Hash()] = e
			vi.Add(e)
			vi.Flush()
			return nil
		},

		Drop: func(e *inter.Event, peer string, err error) {
			t.Fatal(e, err)
		},

		Exists: func(h hash.Event) *inter.Event {
			return processed[h]
		},
	})

	// push
	for _, e := range named {
		orderThenProcess(e, "")
	}

	// check
	for e1name, e1 := range named {
		for e2name, e2 := range named {
			_, expect := relations[e1name][e2name]
			if !assertar.Equal(
				expect,
				vi.StronglySee(e1.Hash(), e2.Hash()),
				fmt.Sprintf("%s strongly sees %s", e1.Hash(), e2.Hash()),
			) {
				return
			}
		}
	}
}

type eventSlot struct {
	seq     idx.Event
	creator hash.Peer
}

// naive implementation of fork detection, O(n)
func test_forksSeen(vi *Index, head hash.Event) (cheaters map[hash.Peer]bool, err error) {
	cheaters = map[hash.Peer]bool{}
	visited := hash.EventsSet{}
	seen := map[eventSlot]int{}
	err = vi.dfsSubgraph(head, func(e *event) (godeeper bool) {
		// ensure visited once
		if visited.Contains(e.Hash()) {
			return false
		}
		visited.Add(e.Hash())

		slot := eventSlot{
			seq:     e.Seq,
			creator: e.Creator,
		}
		seen[slot] += 1
		return true
	})
	for s, count := range seen {
		if count > 1 {
			cheaters[s.creator] = true
		}
	}
	return cheaters, err
}

func TestRandomForksSanity(t *testing.T) {
	nodes := inter.GenNodes(8)
	cheaters := []hash.Peer{nodes[0], nodes[1], nodes[2]}

	members := make(pos.Members, len(nodes))
	for _, peer := range nodes {
		members.Add(peer, pos.Stake(1))
	}

	members.Add(cheaters[0], pos.Stake(2))
	members.Add(nodes[3], pos.Stake(2))
	members.Add(nodes[4], pos.Stake(3))

	vi := NewIndex(members, kvdb.NewMemDatabase())

	processed := make(map[hash.Event]*inter.Event)
	onNewEvent := func(e *inter.Event) {
		if _, ok := processed[e.Hash()]; ok {
			return
		}
		processed[e.Hash()] = e
		vi.Add(e)
	}
	// Many forks from each node in large graph, so probability of not seeing a fork is negligible
	events := inter.GenEventsByCheaters(nodes, cheaters, 300, 4, 30, nil, onNewEvent, nil)

	vi.Flush()
	vi.DropNotFlushed() // don't drop anything, because everything is flushed

	// quick sanity check. all the nodes should see that cheaters have a fork, and honest nodes don't have forks
	assertar := assert.New(t)
	idxs := members.Idxs()
	for _, node := range nodes {
		ee := events[node]
		highestBefore := vi.GetEvent(ee[len(ee)-1].Hash()).HighestBefore
		for n, cheater := range nodes {
			high := highestBefore[idxs[cheater]]
			isCheater := n < len(cheaters)
			assertar.Equal(isCheater, high.IsForkSeen, cheater.String())
			if isCheater {
				assertar.Equal(idx.Event(0), high.Seq, cheater.String())
			} else {
				assertar.NotEqual(idx.Event(0), high.Seq, cheater.String())
			}
		}
	}
}

func TestRandomForks(t *testing.T) {
	for i, test := range []struct {
		nodesNum    int
		cheatersNum int
		eventsNum   int
		forksNum    int
		parentsNum  int
	}{
		{
			nodesNum:    1,
			parentsNum:  1,
			cheatersNum: 1,
			eventsNum:   10,
			forksNum:    3,
		},
		{
			nodesNum:    2,
			parentsNum:  1,
			cheatersNum: 1,
			eventsNum:   10,
			forksNum:    3,
		},
		{
			nodesNum:    2,
			parentsNum:  2,
			cheatersNum: 2,
			eventsNum:   10,
			forksNum:    3,
		},
		{
			nodesNum:    10,
			parentsNum:  4,
			cheatersNum: 1,
			eventsNum:   10,
			forksNum:    3,
		},
		{
			nodesNum:    10,
			parentsNum:  4,
			cheatersNum: 10,
			eventsNum:   10,
			forksNum:    3,
		},
		{
			nodesNum:    20,
			parentsNum:  4,
			cheatersNum: 10,
			eventsNum:   5,
			forksNum:    2,
		},
		{
			nodesNum:    40,
			parentsNum:  4,
			cheatersNum: 10,
			eventsNum:   3,
			forksNum:    1,
		},
		{
			nodesNum:    5,
			parentsNum:  4,
			cheatersNum: 2,
			eventsNum:   30,
			forksNum:    30,
		},
	} {
		t.Run(fmt.Sprintf("Test #%d", i), func(t *testing.T) {
			r := rand.New(rand.NewSource(int64(i)))

			nodes := inter.GenNodes(test.nodesNum)
			cheaters := nodes[:test.cheatersNum]

			members := make(pos.Members, len(nodes))
			for _, peer := range nodes {
				members.Add(peer, pos.Stake(1))
			}

			vi := NewIndex(members, kvdb.NewMemDatabase())

			processed := make(map[hash.Event]*inter.Event)
			onNewEvent := func(e *inter.Event) {
				if _, ok := processed[e.Hash()]; ok {
					return
				}
				processed[e.Hash()] = e
				vi.Add(e)
			}
			_ = inter.GenEventsByCheaters(nodes, cheaters, test.eventsNum, test.parentsNum, test.forksNum, nil, onNewEvent, r)

			assertar := assert.New(t)
			idxs := members.Idxs()
			// check that fork seeing is identical to naive version
			for _, e := range processed {
				highestBefore := vi.GetEvent(e.Hash()).HighestBefore
				expectedCheaters, err := test_forksSeen(vi, e.Hash())
				assertar.NoError(err)

				for _, cheater := range nodes {
					expectedCheater := expectedCheaters[cheater]
					high := highestBefore[idxs[cheater]]
					assertar.Equal(expectedCheater, high.IsForkSeen, cheater.String()+"_"+e.Creator.String())
					if expectedCheater {
						assertar.Equal(idx.Event(0), high.Seq, cheater.String()+"_"+e.Creator.String())
					}
				}
			}

			vi.DropNotFlushed() // drops everything
			for _, e := range processed {
				assertar.Nil(vi.GetEvent(e.Hash()))
			}
		})
	}
}

/*
// codegen4StronglySeenStability is for test data generation.
func codegen4StronglySeenStability() {
	peers := inter.GenNodes(4)
	events := inter.GenEventsByNode(peers, 20, 2, nil, nil, nil)

	members := make(pos.Members, len(peers))
	for _, peer := range peers {
		members.Add(peer, pos.Stake(1))
	}
	vi := NewIndex(members, kvdb.NewMemDatabase())

	processed := make(map[hash.Event]*inter.Event)
	orderThenProcess := ordering.EventBuffer(ordering.Callback{

		Process: func(e *inter.Event) {
			processed[e.Hash()] = e
			vi.Add(e)
		},

		Drop: func(e *inter.Event, err error) {
			panic(err)
		},

		Exists: func(h hash.Event) *inter.Event {
			return processed[h]
		},
	})

	// push
	dag := inter.Events{}
	for _, ee := range events {
		for _, e := range ee {
			orderThenProcess(e)
		}
		dag = append(dag, ee...)
	}

	// generation
	scheme, err := inter.DAGtoASCIIscheme(dag)
	if err != nil {
		panic(err)
	}

	fmt.Printf("dag := `%s`\n", scheme)
	fmt.Printf("relations := map[string]map[string]struct{}{\n")
	for _, e1 := range dag {
		sees := fmt.Sprintf("\"%s\": map[string]struct{}{", e1.Hash())
		for _, e2 := range dag {
			if vi.StronglySee(e1.Hash(), e2.Hash()) {
				sees = sees + fmt.Sprintf("\"%s\":{},", e2.Hash())
			}
		}
		sees += "},"
		fmt.Println(sees)
	}
	fmt.Printf("}\n")
}
*/
